<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>ëŠë¦°ì•„ì´ ë§ì…ˆ ì—°ìŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        warm: {
                            50: '#FDFCFA', 100: '#FAF7F2', 200: '#F3EDE4',
                            300: '#E8DFD2', 400: '#B8AD9E', 500: '#8C8070',
                            600: '#6B5F50', 700: '#4A4035', 800: '#2E261D',
                        },
                        app: {
                            blue: '#6BADE8', 'blue-light': '#D9EDFC', 'blue-soft': '#EEF6FD',
                            orange: '#F0A050', 'orange-light': '#FDE8C8', 'orange-soft': '#FFF6EB',
                            green: '#5BC886', 'green-light': '#D4F5E0',
                            red: '#F07070',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;900&display=swap');

        *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0; padding: 0;
            background: #F5F1EB;
            min-height: 100dvh;
            display: flex; justify-content: center; align-items: flex-start;
        }

        /* â”€â”€ App Container â”€â”€ */
        .app {
            width: 100%; max-width: 480px;
            min-height: 100dvh;
            background: white;
            padding: 24px 20px;
            padding-top: max(24px, env(safe-area-inset-top));
            padding-bottom: max(24px, env(safe-area-inset-bottom));
            display: flex; flex-direction: column;
        }

        @media (min-width: 768px) {
            body { align-items: center; padding: 32px; }
            .app {
                max-width: 560px;
                min-height: auto;
                border-radius: 32px;
                box-shadow: 0 8px 48px rgba(0,0,0,0.07), 0 1px 4px rgba(0,0,0,0.04);
                padding: 44px 40px;
            }
        }

        /* â”€â”€ ê³ ë¥´ê¸° ëª¨ë“œ dots â”€â”€ */
        .dot { border-radius: 50%; }
        .dot-sm { width: 16px; height: 16px; }
        .dot-md { width: 20px; height: 20px; }
        @media (min-width: 768px) {
            .dot-sm { width: 20px; height: 20px; }
            .dot-md { width: 24px; height: 24px; }
        }

        /* â”€â”€ ìŒ“ê¸° ëª¨ë“œ: ì†ŒìŠ¤ dot â”€â”€ */
        .source-dot {
            width: 28px; height: 28px; border-radius: 50%;
            cursor: grab; touch-action: none; user-select: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s, opacity 0.15s;
        }
        .source-dot:active { cursor: grabbing; transform: scale(1.12); }
        @media (min-width: 768px) {
            .source-dot { width: 32px; height: 32px; }
        }

        /* â”€â”€ ìŒ“ê¸° ëª¨ë“œ: ì¡´ dot â”€â”€ */
        .zone-dot {
            width: 24px; height: 24px; border-radius: 50%;
            cursor: grab; touch-action: none; user-select: none;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            transition: transform 0.12s, opacity 0.15s;
        }
        .zone-dot:active { cursor: grabbing; transform: scale(1.12); }
        @media (min-width: 768px) {
            .zone-dot { width: 28px; height: 28px; }
        }

        /* â”€â”€ ë“œë¡­ ì¡´ â”€â”€ */
        .drop-zone {
            min-height: 80px; border: 2.5px dashed;
            border-radius: 16px; padding: 8px;
            display: grid; grid-template-columns: repeat(5, 24px); gap: 4px;
            align-content: start; justify-content: center;
            transition: background 0.18s, border-color 0.18s;
        }
        .drop-zone.blue-zone { border-color: #B8D9F5; background: #F5FAFF; }
        .drop-zone.orange-zone { border-color: #F5D5A8; background: #FFFAF2; }
        .drop-zone.drag-over-blue { background: #D9EDFC !important; border-color: #6BADE8 !important; border-style: solid !important; }
        .drop-zone.drag-over-orange { background: #FDE8C8 !important; border-color: #F0A050 !important; border-style: solid !important; }
        @media (min-width: 768px) {
            .drop-zone {
                min-height: 90px; padding: 10px;
                grid-template-columns: repeat(5, 28px); gap: 5px;
            }
        }

        /* â”€â”€ ë“œë˜ê·¸ í”Œë¡œíŒ… â”€â”€ */
        .floating-circle {
            position: fixed; z-index: 9999; pointer-events: none;
            width: 32px; height: 32px; border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        /* â”€â”€ ë²„íŠ¼ ê³µí†µ â”€â”€ */
        .btn-option {
            border: 2.5px solid #E8E2DA;
            background: white;
            border-radius: 16px;
            font-weight: 700;
            color: #4A4035;
            transition: transform 0.1s, border-color 0.15s, background 0.15s;
            cursor: pointer;
            user-select: none;
        }
        .btn-option:active:not(:disabled) { transform: scale(0.95); }
        .btn-option:disabled { cursor: default; }
        .btn-option.correct {
            background: #D4F5E0 !important; border-color: #5BC886 !important; color: #1A7A3A !important;
        }
        .btn-option.wrong {
            background: #FDE8E8 !important; border-color: #F07070 !important; color: #B91C1C !important; opacity: 0.5;
        }

        /* â”€â”€ ìŒ“ê¸° ì •ë‹µ ì„ íƒ â”€â”€ */
        .ans-btn {
            border: 2.5px solid #E8E2DA; background: white;
            border-radius: 14px; font-weight: 700; color: #4A4035;
            transition: transform 0.1s, border-color 0.15s, background 0.15s;
            cursor: pointer; user-select: none;
        }
        .ans-btn:active:not(:disabled) { transform: scale(0.95); }
        .ans-selected {
            background: #D4F5E0 !important; border-color: #5BC886 !important; color: #1A7A3A !important;
        }

        /* â”€â”€ ëª¨ë“œ ì¹´ë“œ â”€â”€ */
        .mode-card {
            transition: transform 0.12s, box-shadow 0.12s;
            cursor: pointer; user-select: none;
        }
        .mode-card:active { transform: scale(0.97); }
        .mode-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.06); }

        /* â”€â”€ ì±„ìš°ê¸° ì…€ â”€â”€ */
        .fill-cell {
            width: 48px; height: 48px; border-radius: 50%;
            border: 2.5px dashed #D8D2C8; background: #FDFCFA;
            cursor: pointer; user-select: none;
            transition: all 0.18s;
        }
        .fill-cell:active:not(.locked) { transform: scale(0.9); }
        .fill-cell.blue-filled {
            border: 2.5px solid #6BADE8; background: #6BADE8;
            box-shadow: 0 2px 8px rgba(107,173,232,0.25);
        }
        .fill-cell.orange-filled {
            border: 2.5px solid #F0A050; background: #F0A050;
            box-shadow: 0 2px 8px rgba(240,160,80,0.25);
        }
        .fill-cell.locked { cursor: default; opacity: 0.85; }
        .fill-cell.blue-filled, .fill-cell.orange-filled { cursor: grab; touch-action: none; }
        .fill-cell.blue-filled:active, .fill-cell.orange-filled:active { cursor: grabbing; }
        .fill-cell.fill-drag-over { border-color: #5BC886 !important; border-style: solid !important; background: #D4F5E0 !important; }
        @media (min-width: 768px) {
            .fill-cell { width: 56px; height: 56px; }
        }

        /* â”€â”€ í”„ë¡œê·¸ë ˆìŠ¤ ë°” â”€â”€ */
        .progress-track {
            height: 8px; border-radius: 99px;
            background: #F0ECE6; overflow: hidden;
        }
        .progress-bar {
            height: 100%; border-radius: 99px;
            background: linear-gradient(90deg, #6BADE8, #5BC886);
            transition: width 0.5s ease;
        }

        /* â”€â”€ ìˆ˜ì‹ ìˆ«ì â”€â”€ */
        .eq-num {
            font-size: 3rem; font-weight: 900; line-height: 1;
        }
        .eq-op {
            font-size: 2rem; font-weight: 600; color: #C8C0B4; line-height: 1;
        }
        @media (min-width: 768px) {
            .eq-num { font-size: 3.75rem; }
            .eq-op { font-size: 2.5rem; }
        }

        /* â”€â”€ ì¶©ë™ë°©ì§€ í† ê¸€ â”€â”€ */
        .toggle-track {
            width: 48px; height: 28px;
            border-radius: 99px; position: relative;
            background: #E0DAD0; transition: background 0.2s;
            cursor: pointer; flex-shrink: 0;
        }
        .toggle-track.on { background: #5BC886; }
        .toggle-knob {
            width: 22px; height: 22px;
            border-radius: 50%; background: white;
            position: absolute; top: 3px; left: 3px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.12);
            transition: transform 0.2s;
        }
        .toggle-track.on .toggle-knob { transform: translateX(20px); }

        /* â”€â”€ ì¶©ë™ë°©ì§€ ì´ˆ ì„ íƒ â”€â”€ */
        .imp-sec {
            flex: 1; padding: 8px 0;
            font-size: 0.75rem; font-weight: 600;
            border-radius: 10px; border: 2px solid #E8E2DA;
            background: white; color: #8C8070;
            cursor: pointer; transition: all 0.15s;
            text-align: center;
        }
        .imp-sec.active {
            border-color: #5BC886; background: #D4F5E0; color: #1A7A3A;
        }

        /* â”€â”€ ì¶©ë™ë°©ì§€ ëª¨ë“œ ì˜µì…˜ â”€â”€ */
        .impulse-mode-options {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
            margin-bottom: 10px;
        }
        .impulse-mode-btn {
            display: flex; flex-direction: column; align-items: center;
            padding: 10px 8px;
            border-radius: 14px;
            border: 2px solid #E8E2DA;
            background: white;
            cursor: pointer;
            transition: all 0.15s;
        }
        .impulse-mode-btn.selected { border-color: #5BC886; background: #D4F5E0; }
        .impulse-mode-icon { font-size: 1.2rem; margin-bottom: 2px; }
        .impulse-mode-label { font-size: 0.8rem; font-weight: 700; color: #4A4035; }
        .impulse-mode-desc { font-size: 0.65rem; color: #B8AD9E; margin-top: 1px; }
        .chips-hidden { visibility: hidden; }
        .chips-locked { pointer-events: none; opacity: 0.45; }
        .delay-countdown {
            text-align: center;
            font-size: 1.5rem; font-weight: 900;
            color: #5BC886;
            padding: 16px 0;
            animation: pulse-count 1s ease infinite;
        }
        @keyframes pulse-count {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.7; }
        }

        /* â”€â”€ í˜ì´ë“œ ì¸ â”€â”€ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }

        /* â”€â”€ ì •ë‹µ ë™ê·¸ë¼ë¯¸ íŒ ì• ë‹ˆë©”ì´ì…˜ â”€â”€ */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            45% { transform: scale(1.5); opacity: 1; }
            65% { transform: scale(0.85); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .answer-dot {
            width: 22px; height: 22px; border-radius: 50%;
            opacity: 0;
            animation: popIn 0.4s ease-out forwards;
        }
        @media (min-width: 768px) {
            .answer-dot { width: 26px; height: 26px; }
        }

        /* â”€â”€ í™ˆ ë²„íŠ¼ â”€â”€ */
        .btn-home {
            width: 36px; height: 36px; border-radius: 10px;
            border: 2px solid #E8E2DA; background: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: background 0.15s;
            font-size: 1rem; color: #8C8070;
        }
        .btn-home:active { background: #F5F1EB; }
        @media (min-width: 768px) {
            .btn-home { width: 40px; height: 40px; }
        }
    </style>
</head>
<body>

<div class="app">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì‹œì‘ í™”ë©´ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="start-view" class="flex flex-col flex-1">

        <!-- í—¤ë” -->
        <div class="text-center pt-4 pb-6">
            <!-- ê±°ë¶ì´ ìºë¦­í„° -->
            <div class="inline-block mb-3">
                <svg viewBox="0 0 120 100" width="120" height="100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- ë’·ë‹¤ë¦¬ -->
                    <ellipse cx="30" cy="72" rx="10" ry="6" fill="#F2DC8C" stroke="#3A9B6A" stroke-width="2" transform="rotate(-20 30 72)"/>
                    <ellipse cx="78" cy="76" rx="10" ry="6" fill="#F2DC8C" stroke="#3A9B6A" stroke-width="2" transform="rotate(15 78 76)"/>
                    <!-- ì•ë‹¤ë¦¬ -->
                    <ellipse cx="28" cy="54" rx="9" ry="5.5" fill="#F2DC8C" stroke="#3A9B6A" stroke-width="2" transform="rotate(-10 28 54)"/>
                    <!-- ê¼¬ë¦¬ -->
                    <path d="M18 60 L10 55" stroke="#F2DC8C" stroke-width="4" stroke-linecap="round"/>
                    <!-- ëª¸í†µ -->
                    <ellipse cx="55" cy="58" rx="35" ry="20" fill="#F5E6C8" stroke="#3A9B6A" stroke-width="2"/>
                    <!-- ë“±ê»ì§ˆ -->
                    <ellipse cx="52" cy="42" rx="32" ry="28" fill="#7EDCAA" stroke="#3A9B6A" stroke-width="2.5"/>
                    <!-- ë“±ê»ì§ˆ íŒ¨í„´ -->
                    <path d="M52 18 L42 32 L42 48 L52 58 L62 48 L62 32 Z" fill="none" stroke="#3A9B6A" stroke-width="1.3" opacity="0.35"/>
                    <line x1="42" y1="32" x2="24" y2="38" stroke="#3A9B6A" stroke-width="1.3" opacity="0.35"/>
                    <line x1="62" y1="32" x2="80" y2="38" stroke="#3A9B6A" stroke-width="1.3" opacity="0.35"/>
                    <line x1="42" y1="48" x2="26" y2="56" stroke="#3A9B6A" stroke-width="1.3" opacity="0.35"/>
                    <line x1="62" y1="48" x2="78" y2="56" stroke="#3A9B6A" stroke-width="1.3" opacity="0.35"/>
                    <!-- ë“±ê»ì§ˆ í•˜ì´ë¼ì´íŠ¸ -->
                    <ellipse cx="42" cy="26" rx="6" ry="4" fill="white" opacity="0.35" transform="rotate(-15 42 26)"/>
                    <ellipse cx="62" cy="36" rx="4" ry="3" fill="white" opacity="0.2"/>
                    <!-- ë¨¸ë¦¬ -->
                    <ellipse cx="92" cy="40" rx="17" ry="15" fill="#F5E6C8" stroke="#3A9B6A" stroke-width="2.5"/>
                    <!-- ì•ë‹¤ë¦¬ (ë¨¸ë¦¬ ì•) -->
                    <ellipse cx="82" cy="72" rx="10" ry="6" fill="#F2DC8C" stroke="#3A9B6A" stroke-width="2" transform="rotate(10 82 72)"/>
                    <!-- ëˆˆ -->
                    <circle cx="99" cy="35" r="4" fill="white" stroke="#3A9B6A" stroke-width="1.5"/>
                    <circle cx="100" cy="34" r="2.5" fill="#3A9B6A"/>
                    <circle cx="101" cy="33" r="1" fill="white"/>
                    <!-- ë³¼ -->
                    <circle cx="100" cy="44" r="3.5" fill="#F0A050" opacity="0.4"/>
                    <!-- ë¯¸ì†Œ -->
                    <path d="M94 46 Q98 50 103 46" fill="none" stroke="#3A9B6A" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </div>
            <!-- ì•± ì´ë¦„ -->
            <h1 class="text-3xl font-black tracking-tight">
                <span style="color:#2E7FD9;">ëŠë¦°</span><span style="color:#F0901E;">ì•„ì´</span> <span style="color:#4A4035;">ë§ì…ˆ ì—°ìŠµ</span>
            </h1>
        </div>

        <!-- ëª¨ë“œ ì„ íƒ -->
        <div class="flex flex-col gap-4 flex-1">

            <!-- ê³ ë¥´ê¸° ëª¨ë“œ -->
            <div>
                <div class="flex items-center gap-2 mb-2 px-1">
                    <span class="text-base">ğŸ‘†</span>
                    <span class="text-sm font-semibold" style="color:#6B5F50;">ê³ ë¥´ê¸°</span>
                    <span class="text-xs" style="color:#B8AD9E;">ë™ê·¸ë¼ë¯¸ ì„¸ê³  ë‹µ ê³ ë¥´ê¸°</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="startGame('select',5)"
                            class="mode-card rounded-2xl p-4 text-left border-2" style="border-color:#E8E2DA; background:white;">
                        <p class="text-lg font-bold" style="color:#4A4035;">1 ë¶€í„° 5</p>
                        <p class="text-xs mt-0.5" style="color:#B8AD9E;">ì‘ì€ ìˆ˜ë¼ë¦¬</p>
                    </button>
                    <button onclick="startGame('select',10)"
                            class="mode-card rounded-2xl p-4 text-left border-2" style="border-color:#E8E2DA; background:white;">
                        <p class="text-lg font-bold" style="color:#4A4035;">1 ë¶€í„° 10</p>
                        <p class="text-xs mt-0.5" style="color:#B8AD9E;">í° ìˆ˜ë„ ë„ì „</p>
                    </button>
                </div>
            </div>

            <!-- ìŒ“ê¸° ëª¨ë“œ -->
            <div>
                <div class="flex items-center gap-2 mb-2 px-1">
                    <span style="vertical-align:middle;">
                        <svg width="18" height="18" viewBox="0 0 36 36" style="display:inline-block;vertical-align:middle;">
                            <rect x="2" y="20" width="14" height="14" rx="3" fill="#6BADE8"/>
                            <rect x="20" y="20" width="14" height="14" rx="3" fill="#F0A050"/>
                            <rect x="11" y="4" width="14" height="14" rx="3" fill="#5BC886"/>
                        </svg>
                    </span>
                    <span class="text-sm font-semibold" style="color:#6B5F50;">ìŒ“ê¸°</span>
                    <span class="text-xs" style="color:#B8AD9E;">ë™ê·¸ë¼ë¯¸ ëŒì–´ë‹¤ ë†“ê¸°</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="startGame('drag',5)"
                            class="mode-card rounded-2xl p-4 text-left border-2" style="border-color:#E8E2DA; background:white;">
                        <p class="text-lg font-bold" style="color:#4A4035;">1 ë¶€í„° 5</p>
                        <p class="text-xs mt-0.5" style="color:#B8AD9E;">ì‘ì€ ìˆ˜ë¼ë¦¬</p>
                    </button>
                    <button onclick="startGame('drag',10)"
                            class="mode-card rounded-2xl p-4 text-left border-2" style="border-color:#E8E2DA; background:white;">
                        <p class="text-lg font-bold" style="color:#4A4035;">1 ë¶€í„° 10</p>
                        <p class="text-xs mt-0.5" style="color:#B8AD9E;">í° ìˆ˜ë„ ë„ì „</p>
                    </button>
                </div>
            </div>

            <!-- ì±„ìš°ê¸° ëª¨ë“œ -->
            <div>
                <div class="flex items-center gap-2 mb-2 px-1">
                    <span class="text-base">ğŸ”µğŸŸ </span>
                    <span class="text-sm font-semibold" style="color:#6B5F50;">ì±„ìš°ê¸°</span>
                    <span class="text-xs" style="color:#B8AD9E;">ì¹¸ì— ë™ê·¸ë¼ë¯¸ ì±„ìš°ê¸°</span>
                </div>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="startGame('fill',10)"
                            class="mode-card rounded-2xl p-4 text-left border-2" style="border-color:#E8E2DA; background:white;">
                        <p class="text-lg font-bold" style="color:#4A4035;">í•©ì´ 10 ì´í•˜</p>
                        <p class="text-xs mt-0.5" style="color:#B8AD9E;">ë‘ ìˆ˜ì˜ í•©ì´ 10ì„ ë„˜ì§€ ì•Šì•„ìš”</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- ìŒì„± ì„¤ì • -->
        <div class="mt-6 pt-5" style="border-top: 1.5px solid #F0ECE6;">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-sm font-semibold" style="color:#4A4035;">ìŒì„±</p>
                    <p class="text-xs mt-0.5" style="color:#B8AD9E;">ì •ë‹µ/ì˜¤ë‹µ ìŒì„± ì•ˆë‚´</p>
                </div>
                <button id="tts-toggle" onclick="toggleTTS()" role="switch" aria-checked="true"
                        class="toggle-track on">
                    <span id="tts-knob" class="toggle-knob"></span>
                </button>
            </div>
        </div>

        <!-- ì¶©ë™ë°©ì§€ (ê³ ë¥´ê¸° ì „ìš©) -->
        <div class="pt-5" style="border-top: 1.5px solid #F0ECE6;">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-sm font-semibold" style="color:#4A4035;">
                        ì¶©ë™ë°©ì§€
                        <span class="text-xs font-normal ml-1" style="color:#B8AD9E;">ê³ ë¥´ê¸° ëª¨ë“œ</span>
                    </p>
                    <p class="text-xs mt-0.5" style="color:#B8AD9E;">ì„ íƒì§€ê°€ <span id="impulse-label">êº¼ì§</span></p>
                </div>
                <button id="impulse-toggle" onclick="toggleImpulsePrevention()" role="switch" aria-checked="false"
                        class="toggle-track">
                    <span id="impulse-knob" class="toggle-knob"></span>
                </button>
            </div>
            <div id="impulse-details" class="hidden">
                <div class="impulse-mode-options">
                    <button class="impulse-mode-btn" onclick="setImpulseMode('hide')" data-mode="hide">
                        <span class="impulse-mode-icon">ğŸ™ˆ</span>
                        <span class="impulse-mode-label">ë³´ê¸° ìˆ¨ê¸°ê¸°</span>
                        <span class="impulse-mode-desc">Nì´ˆ í›„ ë³´ê¸°ê°€ ë‚˜íƒ€ë‚˜ìš”</span>
                    </button>
                    <button class="impulse-mode-btn selected" onclick="setImpulseMode('lock')" data-mode="lock">
                        <span class="impulse-mode-icon">ğŸ”’</span>
                        <span class="impulse-mode-label">ì„ íƒ ì ê¸ˆ</span>
                        <span class="impulse-mode-desc">Nì´ˆ ë™ì•ˆ ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”</span>
                    </button>
                </div>
                <div class="flex gap-1">
                    <button onclick="setImpulseDelay(1)" class="imp-sec">1ì´ˆ</button>
                    <button onclick="setImpulseDelay(2)" class="imp-sec">2ì´ˆ</button>
                    <button onclick="setImpulseDelay(3)" class="imp-sec">3ì´ˆ</button>
                    <button onclick="setImpulseDelay(4)" class="imp-sec">4ì´ˆ</button>
                    <button onclick="setImpulseDelay(5)" class="imp-sec active">5ì´ˆ</button>
                    <button onclick="setImpulseDelay(6)" class="imp-sec">6ì´ˆ</button>
                    <button onclick="setImpulseDelay(7)" class="imp-sec">7ì´ˆ</button>
                    <button onclick="setImpulseDelay(8)" class="imp-sec">8ì´ˆ</button>
                    <button onclick="setImpulseDelay(9)" class="imp-sec">9ì´ˆ</button>
                    <button onclick="setImpulseDelay(10)" class="imp-sec">10ì´ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ê³ ë¥´ê¸° í™”ë©´ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="play-view" class="hidden flex flex-col flex-1 fade-in">
        <!-- ìƒë‹¨ ë°” -->
        <div class="flex items-center gap-3 mb-2">
            <button onclick="resetGame()" class="btn-home" title="í™ˆ">
                <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l9-8 9 8M5 11v9a1 1 0 001 1h3m8 0h3a1 1 0 001-1v-9"/></svg>
            </button>
            <div class="flex-1">
                <div class="flex justify-between items-center mb-1">
                    <span id="q-label" class="text-xs font-medium" style="color:#B8AD9E;">ë¬¸ì œ 1 / 10</span>
                    <span class="text-xs font-medium" style="color:#B8AD9E;">ë§íŒ ë¬¸ì œ: <span id="score" style="color:#5BC886;">0</span></span>
                </div>
                <div class="progress-track">
                    <div id="progress" class="progress-bar" style="width:10%"></div>
                </div>
            </div>
        </div>

        <!-- ìˆ˜ì‹ + ë™ê·¸ë¼ë¯¸ -->
        <div class="flex-1 flex flex-col justify-center">
            <div class="flex items-start justify-center gap-4 mb-8" style="padding-top:8px;">
                <div class="flex flex-col items-center" style="min-width:68px;">
                    <span id="n1" class="eq-num" style="color:#6BADE8;">1</span>
                    <div id="dots1" class="mt-3" style="display:grid; grid-template-columns:repeat(5, 18px); gap:4px; min-height:22px;"></div>
                </div>
                <div class="flex flex-col items-center pt-2">
                    <span class="eq-op">+</span>
                </div>
                <div class="flex flex-col items-center" style="min-width:68px;">
                    <span id="n2" class="eq-num" style="color:#F0A050;">1</span>
                    <div id="dots2" class="mt-3" style="display:grid; grid-template-columns:repeat(5, 18px); gap:4px; min-height:22px;"></div>
                </div>
                <div class="flex flex-col items-center pt-2">
                    <span class="eq-op">=</span>
                </div>
                <div class="flex flex-col items-center" style="min-width:68px;">
                    <span id="pans" class="eq-num" style="color:#D8D2C8;">?</span>
                    <div id="answer-dots" class="mt-3" style="display:grid; grid-template-columns:repeat(5, 24px); gap:5px; min-height:26px; justify-content:center;"></div>
                </div>
            </div>

            <!-- ì„ íƒì§€ -->
            <div id="options" class="grid grid-cols-2 gap-3 mb-4"></div>
        </div>

        <!-- í”¼ë“œë°± -->
        <div id="feedback" class="text-center h-8 text-base font-bold" style="color:#4A4035;"></div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìŒ“ê¸° í™”ë©´ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="drag-view" class="hidden flex flex-col flex-1 fade-in">
        <!-- ìƒë‹¨ ë°” -->
        <div class="flex items-center gap-3 mb-2">
            <button onclick="resetGame()" class="btn-home" title="í™ˆ">
                <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l9-8 9 8M5 11v9a1 1 0 001 1h3m8 0h3a1 1 0 001-1v-9"/></svg>
            </button>
            <div class="flex-1">
                <div class="flex justify-between items-center mb-1">
                    <span id="dq-label" class="text-xs font-medium" style="color:#B8AD9E;">ë¬¸ì œ 1 / 10</span>
                    <span class="text-xs font-medium" style="color:#B8AD9E;">ë§íŒ ë¬¸ì œ: <span id="dscore" style="color:#5BC886;">0</span></span>
                </div>
                <div class="progress-track">
                    <div id="dprogress" class="progress-bar" style="width:10%"></div>
                </div>
            </div>
        </div>

        <!-- ìˆ˜ì‹ -->
        <div class="flex items-center justify-center gap-3 mb-4 mt-2">
            <span id="dn1" class="eq-num" style="color:#6BADE8;">?</span>
            <span class="eq-op">+</span>
            <span id="dn2" class="eq-num" style="color:#F0A050;">?</span>
            <span class="eq-op">=</span>
            <span id="dans" class="eq-num" style="color:#D8D2C8;">?</span>
        </div>

        <!-- ë“œë¡­ ì¡´ -->
        <div class="flex gap-3 mb-1">
            <div class="flex-1 flex flex-col">
                <p class="text-xs font-semibold mb-1.5 text-center" style="color:#6BADE8;">íŒŒë€ ë™ê·¸ë¼ë¯¸</p>
                <div id="blue-drop" class="drop-zone blue-zone"></div>
                <p id="blue-count" class="text-xs text-center mt-1 font-medium" style="color:#B8AD9E;">0ê°œ</p>
            </div>
            <div class="flex-1 flex flex-col">
                <p class="text-xs font-semibold mb-1.5 text-center" style="color:#F0A050;">ì£¼í™© ë™ê·¸ë¼ë¯¸</p>
                <div id="orange-drop" class="drop-zone orange-zone"></div>
                <p id="orange-count" class="text-xs text-center mt-1 font-medium" style="color:#B8AD9E;">0ê°œ</p>
            </div>
        </div>

        <!-- ì•ˆë‚´ -->
        <p class="text-center text-xs mb-3" style="color:#D0C8BC;">ëŒì–´ë‹¤ ìƒ‰ê¹”ì— ë§ëŠ” ì¹¸ì— ë„£ì–´ìš” Â· ëŒì–´ì„œ ì œê±°</p>

        <!-- ì†ŒìŠ¤ íŠ¸ë ˆì´ -->
        <div class="rounded-2xl py-3 px-3 mb-4 flex items-center justify-center gap-3 border-2" style="background:#FDFCFA; border-color:#F0ECE6;">
            <div id="blue-source" style="display:grid; grid-template-columns:repeat(5, 28px); gap:5px;"></div>
            <div style="width:1.5px; background:#E8E2DA; align-self:stretch; min-height:24px;"></div>
            <div id="orange-source" style="display:grid; grid-template-columns:repeat(5, 28px); gap:5px;"></div>
        </div>

        <!-- ì •ë‹µ ì„ íƒì§€ -->
        <div id="answer-opts" class="grid grid-cols-4 gap-2 mb-3"></div>

        <!-- í”¼ë“œë°± -->
        <div id="dfeedback" class="text-center h-8 text-base font-bold"></div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì±„ìš°ê¸° í™”ë©´ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="fill-view" class="hidden flex flex-col flex-1 fade-in">
        <!-- ìƒë‹¨ ë°” -->
        <div class="flex items-center gap-3 mb-2">
            <button onclick="resetGame()" class="btn-home" title="í™ˆ">
                <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l9-8 9 8M5 11v9a1 1 0 001 1h3m8 0h3a1 1 0 001-1v-9"/></svg>
            </button>
            <div class="flex-1">
                <div class="flex justify-between items-center mb-1">
                    <span id="fq-label" class="text-xs font-medium" style="color:#B8AD9E;">ë¬¸ì œ 1 / 10</span>
                    <span class="text-xs font-medium" style="color:#B8AD9E;">ë§íŒ ë¬¸ì œ: <span id="fscore" style="color:#5BC886;">0</span></span>
                </div>
                <div class="progress-track">
                    <div id="fprogress" class="progress-bar" style="width:10%"></div>
                </div>
            </div>
        </div>

        <!-- ìˆ˜ì‹ -->
        <div class="flex items-center justify-center gap-3 mb-3 mt-2">
            <span id="fn1" class="eq-num" style="color:#6BADE8;">?</span>
            <span class="eq-op">+</span>
            <span id="fn2" class="eq-num" style="color:#F0A050;">?</span>
            <span class="eq-op">=</span>
            <span id="fans" class="eq-num" style="color:#D8D2C8;">?</span>
        </div>

        <!-- ìƒ‰ ì„ íƒ -->
        <div id="fill-color-picker" class="flex justify-center gap-5 mb-5">
            <button id="pick-blue-btn"
                    class="w-14 h-14 rounded-full border-4 transition active:scale-95"
                    style="background:#6BADE8; border-color:#D9EDFC; box-shadow:0 2px 8px rgba(107,173,232,0.2); touch-action:none; cursor:grab;"></button>
            <button id="pick-orange-btn"
                    class="w-14 h-14 rounded-full border-4 transition active:scale-95"
                    style="background:#F0A050; border-color:#FDE8C8; box-shadow:0 2px 8px rgba(240,160,80,0.2); touch-action:none; cursor:grab;"></button>
        </div>

        <!-- 2Ã—5 ê·¸ë¦¬ë“œ -->
        <div id="fill-grid" class="grid grid-cols-5 gap-2.5 justify-items-center mb-5 mx-auto" style="max-width:300px;"></div>

        <!-- ì •ë‹µ ì„ íƒ -->
        <div id="fill-answer-section" class="hidden">
            <div id="fill-answer-opts" class="grid grid-cols-4 gap-3 mb-3"></div>
        </div>

        <!-- í”¼ë“œë°± -->
        <div id="ffeedback" class="text-center h-8 text-base font-bold"></div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• ê²°ê³¼ í™”ë©´ â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="result-view" class="hidden flex flex-col flex-1 fade-in">
        <div class="flex-1 flex flex-col justify-center">
            <div class="text-center mb-8">
                <div id="r-emoji" class="text-6xl mb-4">ğŸ‰</div>
                <h2 class="text-2xl font-bold" style="color:#4A4035;">ë‹¤ í’€ì—ˆì–´ìš”!</h2>
            </div>

            <div class="flex flex-col gap-3 mb-8">
                <div class="flex justify-between items-center rounded-2xl p-4" style="background:#F5FAFF; border:1.5px solid #D9EDFC;">
                    <span class="text-sm" style="color:#6B5F50;">í•œ ë²ˆì— ë§íŒ ë¬¸ì œ</span>
                    <span id="r-correct" class="text-lg font-bold" style="color:#4A8FC2;">0 / 10</span>
                </div>
                <div class="flex justify-between items-center rounded-2xl p-4" style="background:#F0FAF4; border:1.5px solid #C5E8D4;">
                    <span class="text-sm" style="color:#6B5F50;">ì •í™•ë„</span>
                    <span id="r-accuracy" class="text-lg font-bold" style="color:#2E8B57;">0%</span>
                </div>
                <div class="flex justify-between items-center rounded-2xl p-4" style="background:#FFFAF2; border:1.5px solid #F5D5A8;">
                    <span class="text-sm" style="color:#6B5F50;">ê±¸ë¦° ì‹œê°„</span>
                    <span id="r-time" class="text-lg font-bold" style="color:#C07830;">0ì´ˆ</span>
                </div>
            </div>
        </div>

        <button onclick="resetGame()"
                class="w-full py-4 rounded-2xl font-bold text-lg border-2 transition hover:opacity-90 active:scale-[0.98]"
                style="border-color:#E8E2DA; color:#6B5F50; background:white;">
            ë‹¤ì‹œ í•˜ê¸°
        </button>
    </div>

</div>

<script>
    // â”€â”€ ìƒíƒœ â”€â”€
    let qNum = 1, correct = 0, n1, n2, ans, startTime, busy = false, tries = 0;
    let questionList = [];
    let ttsEnabled = true;
    let impulsePrevention = false;
    let impulseDelay = 5;
    let impulseMode = 'lock'; // 'hide' = ë³´ê¸° ìˆ¨ê¸°ê¸°, 'lock' = ì„ íƒ ì ê¸ˆ
    let impulseTimer = null;
    let gameMode = 'select';
    let maxNum = 5;

    // ë“œë˜ê·¸ ìƒíƒœ
    let floatingEl = null;
    let floatingColor = null;
    let floatingSourceEl = null;
    let blueCount = 0;
    let orangeCount = 0;

    // ì •ë‹µ ì„ íƒ ìƒíƒœ
    let selectedAnswer = null;
    let selectedAnswerBtn = null;

    // ë“œë˜ê·¸ íƒ€ì…
    let dragType = null; // 'source-to-zone', 'zone-to-remove', 'fill-add', 'fill-remove'
    let dragZoneDot = null;
    let dragFillCellIndex = -1;

    // ì±„ìš°ê¸° ìƒíƒœ
    let fillPhase = 'fill';
    let activeColor = null;
    let fillCells = [];

    // â”€â”€ ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ â”€â”€
    function buildFillQuestionList() {
        const pairs = [];
        for (let a = 1; a <= 9; a++)
            for (let b = 1; b <= 10 - a; b++)
                pairs.push([a, b]);
        for (let i = pairs.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
        }
        return pairs.slice(0, 10);
    }

    function buildQuestionList() {
        const pairs = [];
        for (let a = 1; a <= maxNum; a++)
            for (let b = 1; b <= maxNum; b++)
                pairs.push([a, b]);
        for (let i = pairs.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
        }
        return pairs.slice(0, 10);
    }

    // â”€â”€ ê³ ë¥´ê¸° ëª¨ë“œ â”€â”€
    function makeDots(id, n, color) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        for (let i = 0; i < n; i++) {
            const d = document.createElement('span');
            d.className = 'dot dot-sm';
            d.style.background = color;
            el.appendChild(d);
        }
    }

    function newQuestion() {
        if (impulseTimer) { clearInterval(impulseTimer); impulseTimer = null; }
        busy = false; tries = 0;
        [n1, n2] = questionList[qNum - 1];
        ans = n1 + n2;

        document.getElementById('n1').textContent       = n1;
        document.getElementById('n2').textContent       = n2;
        document.getElementById('q-label').textContent  = `ë¬¸ì œ ${qNum} / 10`;
        document.getElementById('progress').style.width = `${qNum / 10 * 100}%`;
        document.getElementById('feedback').textContent = '';
        document.getElementById('feedback').className   = 'text-center h-8 text-base font-bold';
        document.getElementById('answer-dots').innerHTML = '';
        const pans = document.getElementById('pans');
        pans.textContent = '?'; pans.style.color = '#D8D2C8';

        makeDots('dots1', n1, '#6BADE8');
        makeDots('dots2', n2, '#F0A050');

        const opts = new Set([ans]);
        while (opts.size < 4) opts.add(Math.floor(Math.random() * (maxNum * 2)) + 1);

        const el = document.getElementById('options');
        el.innerHTML = '';
        [...opts].sort(() => Math.random() - 0.5).forEach(v => {
            const b = document.createElement('button');
            b.textContent = v;
            b.className = 'btn-option py-5 text-3xl shadow-sm focus:outline-none';
            b.onclick = () => pick(v, b);
            el.appendChild(b);
        });

        if (impulsePrevention) {
            const isHide = impulseMode === 'hide';
            const optionsEl = document.getElementById('options');
            if (isHide) {
                optionsEl.classList.add('chips-hidden');
            } else {
                const btns = optionsEl.querySelectorAll('button');
                btns.forEach(b => { b.disabled = true; });
                optionsEl.classList.add('chips-locked');
            }
            let countdown = impulseDelay;
            const fb = document.getElementById('feedback');
            fb.textContent = isHide
                ? `${countdown}ì´ˆ í›„ ë³´ê¸°ê°€ ë‚˜ì™€ìš”`
                : `${countdown}ì´ˆ ë™ì•ˆ ìƒê°í•´ ë³´ì„¸ìš”`;
            fb.style.color = '#B8AD9E';
            fb.className = 'text-center h-8 text-sm font-medium';
            impulseTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    fb.textContent = isHide
                        ? `${countdown}ì´ˆ í›„ ë³´ê¸°ê°€ ë‚˜ì™€ìš”`
                        : `${countdown}ì´ˆ ë™ì•ˆ ìƒê°í•´ ë³´ì„¸ìš”`;
                } else {
                    clearInterval(impulseTimer); impulseTimer = null;
                    optionsEl.classList.remove('chips-hidden', 'chips-locked');
                    if (!isHide) {
                        optionsEl.querySelectorAll('button').forEach(b => { b.disabled = false; });
                    }
                    fb.textContent = '';
                    fb.className = 'text-center h-8 text-base font-bold';
                }
            }, 1000);
        }
    }

    function showAnswerDots(count) {
        const container = document.getElementById('answer-dots');
        container.innerHTML = '';
        const delay = 500;
        for (let i = 0; i < count; i++) {
            setTimeout(() => {
                const d = document.createElement('span');
                d.className = 'answer-dot';
                d.style.background = '#5BC886';
                container.appendChild(d);
            }, i * delay);
        }
    }

    function pick(v, btn) {
        if (busy) return;
        tries++;
        const fb = document.getElementById('feedback');
        if (v === ans) {
            busy = true;
            if (impulseTimer) { clearInterval(impulseTimer); impulseTimer = null; }
            document.getElementById('options').classList.remove('chips-hidden', 'chips-locked');
            if (tries === 1) { correct++; document.getElementById('score').textContent = correct; }
            document.querySelectorAll('#options button').forEach(b => {
                b.disabled = true; b.style.cursor = 'default'; b.style.opacity = '';
            });
            btn.classList.add('correct');
            const pans = document.getElementById('pans');
            pans.textContent = ans; pans.style.color = '#5BC886';
            fb.textContent = 'ì •ë‹µì´ì—ìš”! ğŸ‰';
            fb.style.color = '#5BC886';
            fb.className = 'text-center h-8 text-base font-bold';
            speak('ì •ë‹µì´ì—ìš”.');
            showAnswerDots(ans);
            const nextDelay = ans * 500 + 800;
            setTimeout(() => { if (qNum < 10) { qNum++; newQuestion(); } else showResult(); }, nextDelay);
        } else {
            btn.disabled = true; btn.classList.add('wrong');
            fb.textContent = 'ë‹¤ì‹œ ì„¸ì–´ë´ìš”!';
            fb.style.color = '#F07070';
            fb.className = 'text-center h-8 text-base font-bold';
            speak('ë‹¤ì‹œ í•´ë´ìš”.');
        }
    }

    // â”€â”€ ìŒ“ê¸° ëª¨ë“œ â”€â”€
    function newDragQuestion() {
        busy = false; tries = 0;
        blueCount = 0; orangeCount = 0;
        [n1, n2] = questionList[qNum - 1];
        ans = n1 + n2;

        document.getElementById('dn1').textContent       = n1;
        document.getElementById('dn2').textContent       = n2;

        const dans = document.getElementById('dans');
        dans.textContent = '?';
        dans.style.color = '#D8D2C8';

        selectedAnswer = null;
        selectedAnswerBtn = null;

        document.getElementById('dq-label').textContent  = `ë¬¸ì œ ${qNum} / 10`;
        document.getElementById('dprogress').style.width = `${qNum / 10 * 100}%`;
        document.getElementById('dfeedback').textContent = '';
        document.getElementById('dfeedback').className   = 'text-center h-8 text-base font-bold';

        document.getElementById('blue-drop').innerHTML   = '';
        document.getElementById('orange-drop').innerHTML = '';
        updateZoneCounts();
        buildSourceTray();
        buildAnswerOptions();
    }

    function buildAnswerOptions() {
        const opts = new Set([ans]);
        while (opts.size < 4) opts.add(Math.floor(Math.random() * (maxNum * 2)) + 1);

        const el = document.getElementById('answer-opts');
        el.innerHTML = '';
        [...opts].sort(() => Math.random() - 0.5).forEach(v => {
            const b = document.createElement('button');
            b.textContent = v;
            b.className = 'ans-btn py-3 text-2xl focus:outline-none';
            b.onclick = () => selectAnswerChoice(v, b);
            el.appendChild(b);
        });
    }

    function selectAnswerChoice(v, btn) {
        if (busy) return;
        tries++;
        const fb = document.getElementById('dfeedback');
        const blueOk = blueCount === n1;
        const orangeOk = orangeCount === n2;
        const ansOk = v === ans;

        if (blueOk && orangeOk && ansOk) {
            busy = true;
            if (tries === 1) { correct++; document.getElementById('dscore').textContent = correct; }
            document.querySelectorAll('#answer-opts button').forEach(b => b.disabled = true);
            document.querySelectorAll('#blue-drop .zone-dot, #orange-drop .zone-dot')
                .forEach(d => d.style.pointerEvents = 'none');
            btn.classList.add('ans-selected');
            const dans = document.getElementById('dans');
            dans.textContent = ans;
            dans.style.color = '#5BC886';
            fb.textContent = `ì •ë‹µì´ì—ìš”! ğŸ‰ ëª¨ë‘ ${ans}ê°œì˜ˆìš”`;
            fb.style.color = '#5BC886';
            fb.className = 'text-center h-8 text-base font-bold';
            speak(`ì •ë‹µì´ì—ìš”. ëª¨ë‘ ${ans}ê°œì˜ˆìš”.`);
            setTimeout(() => { if (qNum < 10) { qNum++; newDragQuestion(); } else showResult(); }, 1600);
        } else {
            const errors = [];
            if (!blueOk) errors.push('íŒŒë€ ë™ê·¸ë¼ë¯¸ ê°œìˆ˜');
            if (!orangeOk) errors.push('ì£¼í™© ë™ê·¸ë¼ë¯¸ ê°œìˆ˜');
            if (!ansOk) errors.push('ì„ íƒí•œ ë‹µ');
            fb.textContent = errors.join(' Â· ') + 'ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ìš”';
            fb.style.color = '#F07070';
            fb.className = 'text-center h-8 text-sm font-medium';
            speak('ë‹¤ì‹œ í•´ë´ìš”.');
            if (!ansOk) { btn.disabled = true; btn.style.opacity = '0.4'; }
        }
    }

    function buildSourceTray() {
        const blueEl   = document.getElementById('blue-source');
        const orangeEl = document.getElementById('orange-source');
        blueEl.innerHTML   = '';
        orangeEl.innerHTML = '';
        for (let i = 0; i < 10; i++) {
            blueEl.appendChild(makeSourceDot('blue'));
            orangeEl.appendChild(makeSourceDot('orange'));
        }
    }

    function makeSourceDot(color) {
        const d = document.createElement('span');
        d.className = 'source-dot';
        d.style.background = color === 'blue' ? '#6BADE8' : '#F0A050';
        d.addEventListener('mousedown', e => {
            e.preventDefault();
            dragType = 'source-to-zone';
            floatingSourceEl = d;
            d.style.visibility = 'hidden';
            beginDrag(e.clientX, e.clientY, color);
        });
        d.addEventListener('touchstart', e => {
            e.preventDefault();
            dragType = 'source-to-zone';
            floatingSourceEl = d;
            d.style.visibility = 'hidden';
            const t = e.touches[0];
            beginDrag(t.clientX, t.clientY, color);
        }, { passive: false });
        return d;
    }

    function beginDrag(x, y, color) {
        floatingColor = color;
        floatingEl = document.createElement('div');
        floatingEl.className = 'floating-circle';
        floatingEl.style.background = color === 'blue' ? '#6BADE8' : '#F0A050';
        floatingEl.style.left = x + 'px';
        floatingEl.style.top  = y + 'px';
        document.body.appendChild(floatingEl);
        updateZoneHighlight(x, y);
    }

    function moveDrag(x, y) {
        if (!floatingEl) return;
        floatingEl.style.left = x + 'px';
        floatingEl.style.top  = y + 'px';
        if (dragType === 'source-to-zone' || dragType === 'zone-to-remove') {
            updateZoneHighlight(x, y);
        } else if (dragType === 'fill-add' || dragType === 'fill-remove') {
            updateFillCellHighlight(x, y);
        }
    }

    function endDrag(x, y) {
        if (!floatingEl) return;
        const color = floatingColor;
        floatingEl.remove(); floatingEl = null; floatingColor = null;
        clearZoneHighlight();
        clearFillCellHighlight();

        if (dragType === 'source-to-zone') {
            const zoneId = color === 'blue' ? 'blue-drop' : 'orange-drop';
            const zone = document.getElementById(zoneId);
            const rect = zone.getBoundingClientRect();
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                floatingSourceEl = null;
                addToZone(color);
            } else {
                if (floatingSourceEl) {
                    floatingSourceEl.style.visibility = '';
                    floatingSourceEl = null;
                }
            }
        } else if (dragType === 'zone-to-remove') {
            const zoneId = color === 'blue' ? 'blue-drop' : 'orange-drop';
            const zone = document.getElementById(zoneId);
            const rect = zone.getBoundingClientRect();
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                dragZoneDot.style.visibility = '';
            } else {
                dragZoneDot.remove();
                if (color === 'blue') blueCount = Math.max(0, blueCount - 1);
                else orangeCount = Math.max(0, orangeCount - 1);
                const sourceId = color === 'blue' ? 'blue-source' : 'orange-source';
                const sourceEl = document.getElementById(sourceId);
                const hiddenDot = Array.from(sourceEl.children).find(c => c.style.visibility === 'hidden');
                if (hiddenDot) hiddenDot.style.visibility = '';
                else sourceEl.appendChild(makeSourceDot(color));
                updateZoneCounts();
                clearDFeedback();
            }
            dragZoneDot = null;
        } else if (dragType === 'fill-add') {
            const idx = getFillCellAtPoint(x, y);
            if (idx >= 0 && fillPhase === 'fill') {
                fillCells[idx] = color;
                updateFillGridVisuals();
            }
        } else if (dragType === 'fill-remove') {
            const idx = getFillCellAtPoint(x, y);
            if (idx >= 0) {
                fillCells[idx] = color;
            }
            updateFillGridVisuals();
            dragFillCellIndex = -1;
        }

        dragType = null;
    }

    function updateZoneHighlight(x, y) {
        const blueZone   = document.getElementById('blue-drop');
        const orangeZone = document.getElementById('orange-drop');
        blueZone.classList.remove('drag-over-blue', 'drag-over-orange');
        orangeZone.classList.remove('drag-over-blue', 'drag-over-orange');
        if (!floatingColor) return;
        if (floatingColor === 'blue') {
            const r = blueZone.getBoundingClientRect();
            if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom)
                blueZone.classList.add('drag-over-blue');
        } else {
            const r = orangeZone.getBoundingClientRect();
            if (x >= r.left && x <= r.right && y >= r.top && y <= r.bottom)
                orangeZone.classList.add('drag-over-orange');
        }
    }

    function clearZoneHighlight() {
        document.getElementById('blue-drop').classList.remove('drag-over-blue', 'drag-over-orange');
        document.getElementById('orange-drop').classList.remove('drag-over-blue', 'drag-over-orange');
    }

    function addToZone(color) {
        if (busy) return;
        const zone = document.getElementById(color === 'blue' ? 'blue-drop' : 'orange-drop');
        const d = document.createElement('span');
        d.className = 'zone-dot';
        d.style.background = color === 'blue' ? '#6BADE8' : '#F0A050';
        d.addEventListener('mousedown', e => {
            if (busy) return;
            e.preventDefault();
            dragType = 'zone-to-remove';
            dragZoneDot = d;
            d.style.visibility = 'hidden';
            beginDrag(e.clientX, e.clientY, color);
        });
        d.addEventListener('touchstart', e => {
            if (busy) return;
            e.preventDefault();
            dragType = 'zone-to-remove';
            dragZoneDot = d;
            d.style.visibility = 'hidden';
            beginDrag(e.touches[0].clientX, e.touches[0].clientY, color);
        }, { passive: false });
        zone.appendChild(d);
        if (color === 'blue') blueCount++;
        else orangeCount++;
        updateZoneCounts();
        clearDFeedback();
    }

    function updateZoneCounts() {
        document.getElementById('blue-count').textContent   = `${blueCount}ê°œ`;
        document.getElementById('orange-count').textContent = `${orangeCount}ê°œ`;
    }

    function clearDFeedback() {
        const fb = document.getElementById('dfeedback');
        if (fb.textContent && !fb.textContent.includes('ì •ë‹µ')) {
            fb.textContent = '';
            fb.className = 'text-center h-8 text-base font-bold';
        }
    }

    // â”€â”€ ì±„ìš°ê¸° ëª¨ë“œ â”€â”€
    function newFillQuestion() {
        busy = false; tries = 0;
        fillPhase = 'fill';
        activeColor = null;
        fillCells = new Array(10).fill(null);

        [n1, n2] = questionList[qNum - 1];
        ans = n1 + n2;

        document.getElementById('fn1').textContent = n1;
        document.getElementById('fn2').textContent = n2;
        const fans = document.getElementById('fans');
        fans.textContent = '?'; fans.style.color = '#D8D2C8';

        document.getElementById('fq-label').textContent  = `ë¬¸ì œ ${qNum} / 10`;
        document.getElementById('fprogress').style.width  = `${qNum / 10 * 100}%`;
        document.getElementById('ffeedback').textContent  = '';
        document.getElementById('ffeedback').className    = 'text-center h-8 text-base font-bold';

        renderFillGrid();
        updateFillColorPicker();
        updateFillGridVisuals();
        showFillAnswerOptions();
    }

    function getFillCellAtPoint(x, y) {
        const cells = document.querySelectorAll('#fill-grid .fill-cell');
        for (let i = 0; i < cells.length; i++) {
            const rect = cells[i].getBoundingClientRect();
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) return i;
        }
        return -1;
    }

    function updateFillCellHighlight(x, y) {
        clearFillCellHighlight();
        const idx = getFillCellAtPoint(x, y);
        if (idx >= 0) {
            const cells = document.querySelectorAll('#fill-grid .fill-cell');
            cells[idx].classList.add('fill-drag-over');
        }
    }

    function clearFillCellHighlight() {
        document.querySelectorAll('#fill-grid .fill-cell.fill-drag-over').forEach(c => c.classList.remove('fill-drag-over'));
    }

    function renderFillGrid() {
        const grid = document.getElementById('fill-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 10; i++) {
            const cell = document.createElement('div');
            cell.className = 'fill-cell';
            cell.addEventListener('mousedown', e => fillCellDragStart(e, i));
            cell.addEventListener('touchstart', e => fillCellDragStart(e, i), { passive: false });
            grid.appendChild(cell);
        }
    }

    function fillCellDragStart(e, index) {
        if (busy || fillPhase !== 'fill') return;
        if (!fillCells[index]) return;
        e.preventDefault();
        dragType = 'fill-remove';
        dragFillCellIndex = index;
        const color = fillCells[index];
        fillCells[index] = null;
        updateFillGridVisuals();
        const pt = e.touches ? e.touches[0] : e;
        beginDrag(pt.clientX, pt.clientY, color);
    }

    function updateFillGridVisuals() {
        const cells = document.querySelectorAll('#fill-grid .fill-cell');
        cells.forEach((cell, i) => {
            cell.className = 'fill-cell';
            if (fillCells[i] === 'blue') cell.classList.add('blue-filled');
            else if (fillCells[i] === 'orange') cell.classList.add('orange-filled');
            if (fillPhase !== 'fill') cell.classList.add('locked');
            if (busy) cell.classList.add('locked');
        });
    }

    function updateFillColorPicker() {
        const picker = document.getElementById('fill-color-picker');
        if (fillPhase === 'fill') {
            picker.classList.remove('hidden');
        } else {
            picker.classList.add('hidden');
        }
    }

    function showFillAnswerOptions() {
        const section = document.getElementById('fill-answer-section');
        section.classList.remove('hidden');
        const opts = new Set([ans]);
        while (opts.size < 4) {
            const v = Math.floor(Math.random() * 10) + 1;
            opts.add(v);
        }
        const el = document.getElementById('fill-answer-opts');
        el.innerHTML = '';
        [...opts].sort(() => Math.random() - 0.5).forEach(v => {
            const b = document.createElement('button');
            b.textContent = v;
            b.className = 'btn-option py-5 text-3xl shadow-sm focus:outline-none';
            b.onclick = () => pickFillAnswer(v, b);
            el.appendChild(b);
        });
    }

    function pickFillAnswer(v, btn) {
        if (busy) return;
        tries++;
        const fb = document.getElementById('ffeedback');

        if (v !== ans) {
            btn.disabled = true; btn.classList.add('wrong');
            fb.textContent = 'ë‹¤ì‹œ ì„¸ì–´ë´ìš”!';
            fb.style.color = '#F07070';
            fb.className = 'text-center h-8 text-base font-bold';
            speak('ë‹¤ì‹œ í•´ë´ìš”.');
            return;
        }

        const blueC = fillCells.filter(c => c === 'blue').length;
        const orangeC = fillCells.filter(c => c === 'orange').length;

        if (blueC === n1 && orangeC === n2) {
            busy = true;
            fillPhase = 'answer';
            if (tries === 1) { correct++; document.getElementById('fscore').textContent = correct; }
            document.querySelectorAll('#fill-answer-opts button').forEach(b => {
                b.disabled = true; b.style.cursor = 'default'; b.style.opacity = '';
            });
            btn.classList.add('correct');
            const fans = document.getElementById('fans');
            fans.textContent = ans; fans.style.color = '#5BC886';
            updateFillGridVisuals();
            updateFillColorPicker();
            fb.textContent = 'ì •ë‹µì´ì—ìš”! ğŸ‰';
            fb.style.color = '#5BC886';
            fb.className = 'text-center h-8 text-base font-bold';
            speak('ì •ë‹µì´ì—ìš”.');
            setTimeout(() => { if (qNum < 10) { qNum++; newFillQuestion(); } else showResult(); }, 1300);
        } else {
            fb.textContent = 'ë™ê·¸ë¼ë¯¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ë´ìš”!';
            fb.style.color = '#F07070';
            fb.className = 'text-center h-8 text-base font-bold';
            speak('ë‹¤ì‹œ í•´ë´ìš”.');
        }
    }

    // ì „ì—­ ë“œë˜ê·¸ ì´ë²¤íŠ¸
    document.addEventListener('mousemove', e => moveDrag(e.clientX, e.clientY));
    document.addEventListener('mouseup',   e => endDrag(e.clientX, e.clientY));
    document.addEventListener('touchmove', e => {
        if (floatingEl) { e.preventDefault(); const t = e.touches[0]; moveDrag(t.clientX, t.clientY); }
    }, { passive: false });
    document.addEventListener('touchend', e => {
        if (floatingEl) { const t = e.changedTouches[0]; endDrag(t.clientX, t.clientY); }
    });

    // â”€â”€ ê³µí†µ â”€â”€
    function showResult() {
        const sec = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('play-view').classList.add('hidden');
        document.getElementById('drag-view').classList.add('hidden');
        document.getElementById('fill-view').classList.add('hidden');
        document.getElementById('result-view').classList.remove('hidden');
        document.getElementById('r-correct').textContent  = `${correct} / 10`;
        document.getElementById('r-accuracy').textContent = `${correct * 10}%`;
        document.getElementById('r-time').textContent     = `${sec}ì´ˆ`;
        document.getElementById('r-emoji').textContent    =
            correct >= 9 ? 'ğŸ†' : correct >= 7 ? 'ğŸ‰' : correct >= 5 ? 'ğŸ˜Š' : 'ğŸ’ª';
        speak(`ë‹¤ í’€ì—ˆì–´ìš”. ${correct}ê°œ ë§í˜”ì–´ìš”.`);
    }

    function startGame(mode, range) {
        gameMode = mode;
        maxNum = range;
        qNum = 1; correct = 0; startTime = Date.now();
        questionList = mode === 'fill' ? buildFillQuestionList() : buildQuestionList();
        document.getElementById('start-view').classList.add('hidden');
        document.getElementById('result-view').classList.add('hidden');
        if (window.speechSynthesis) speechSynthesis.speak(new SpeechSynthesisUtterance(''));
        setTimeout(() => speak('ì²œì²œíˆ ìƒê°í•˜ê³  í’€ì–´ë³´ì„¸ìš”.'), 100);
        if (mode === 'select') {
            document.getElementById('score').textContent = 0;
            document.getElementById('play-view').classList.remove('hidden');
            newQuestion();
        } else if (mode === 'drag') {
            document.getElementById('dscore').textContent = 0;
            document.getElementById('drag-view').classList.remove('hidden');
            newDragQuestion();
        } else if (mode === 'fill') {
            document.getElementById('fscore').textContent = 0;
            document.getElementById('fill-view').classList.remove('hidden');
            newFillQuestion();
        }
    }

    function resetGame() {
        if (impulseTimer) { clearInterval(impulseTimer); impulseTimer = null; }
        document.querySelectorAll('.chips-hidden, .chips-locked').forEach(el => {
            el.classList.remove('chips-hidden', 'chips-locked');
        });
        if (floatingEl) { floatingEl.remove(); floatingEl = null; }
        document.getElementById('result-view').classList.add('hidden');
        document.getElementById('play-view').classList.add('hidden');
        document.getElementById('drag-view').classList.add('hidden');
        document.getElementById('fill-view').classList.add('hidden');
        document.getElementById('start-view').classList.remove('hidden');
    }

    function toggleTTS() {
        ttsEnabled = !ttsEnabled;
        const tog = document.getElementById('tts-toggle');
        tog.classList.toggle('on', ttsEnabled);
        tog.setAttribute('aria-checked', ttsEnabled);
        if (!ttsEnabled && window.speechSynthesis) window.speechSynthesis.cancel();
    }

    function toggleImpulsePrevention() {
        impulsePrevention = !impulsePrevention;
        const toggle = document.getElementById('impulse-toggle');
        const details = document.getElementById('impulse-details');
        const label  = document.getElementById('impulse-label');
        if (impulsePrevention) {
            toggle.classList.add('on');
            toggle.setAttribute('aria-checked', 'true');
            details.classList.remove('hidden');
            label.textContent = `${impulseDelay}ì´ˆ í›„ í™œì„±í™”ë¼ìš”`;
            highlightImpulseBtn();
        } else {
            toggle.classList.remove('on');
            toggle.setAttribute('aria-checked', 'false');
            details.classList.add('hidden');
            label.textContent = 'êº¼ì§';
        }
    }

    function setImpulseMode(mode) {
        impulseMode = mode;
        document.querySelectorAll('.impulse-mode-btn').forEach(b => {
            b.classList.toggle('selected', b.dataset.mode === mode);
        });
    }

    function setImpulseDelay(sec) {
        impulseDelay = sec;
        document.getElementById('impulse-label').textContent = `${sec}ì´ˆ í›„ í™œì„±í™”ë¼ìš”`;
        highlightImpulseBtn();
    }

    function highlightImpulseBtn() {
        document.querySelectorAll('.imp-sec').forEach((b, i) => {
            if (i + 1 === impulseDelay) {
                b.classList.add('active');
            } else {
                b.classList.remove('active');
            }
        });
    }

    function speak(text) {
        if (!ttsEnabled || !window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ko-KR'; u.rate = 0.9;
        setTimeout(() => window.speechSynthesis.speak(u), 50);
    }

    // ì±„ìš°ê¸° ìƒ‰ìƒ ë“œë˜ê·¸ ì„¤ì •
    ['blue', 'orange'].forEach(color => {
        const btn = document.getElementById(color === 'blue' ? 'pick-blue-btn' : 'pick-orange-btn');
        btn.addEventListener('mousedown', e => {
            if (busy || fillPhase !== 'fill') return;
            e.preventDefault();
            dragType = 'fill-add';
            beginDrag(e.clientX, e.clientY, color);
        });
        btn.addEventListener('touchstart', e => {
            if (busy || fillPhase !== 'fill') return;
            e.preventDefault();
            dragType = 'fill-add';
            beginDrag(e.touches[0].clientX, e.touches[0].clientY, color);
        }, { passive: false });
    });

    if (window.speechSynthesis) {
        speechSynthesis.getVoices();
        if (speechSynthesis.onvoiceschanged !== undefined)
            speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }
</script>

</body>
</html>
